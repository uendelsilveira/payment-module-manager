name: Auto Release

on:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.3
          extensions: mbstring, pdo, sqlite, pdo_sqlite, bcmath, curl, intl, zip, pcov
          coverage: pcov
          tools: composer:v2
          ini-file: production

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-php-8.3-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-interaction --no-progress
        env:
          COMPOSER_ALLOW_SUPERUSER: 1

      - name: Run tests
        env:
          MERCADOPAGO_ACCESS_TOKEN: ${{ secrets.MERCADOPAGO_ACCESS_TOKEN }}
        run: vendor/bin/phpunit

      - name: Run Tests with Coverage
        run: vendor/bin/phpunit --testdox --coverage-clover=coverage.xml
        continue-on-error: true

      - name: Run Laravel Pint
        run: |
          if [ -f vendor/bin/pint ]; then
            vendor/bin/pint --test
          else
            echo "Laravel Pint nÃ£o instalado â€” etapa ignorada."
          fi

      - name: Analyze commits and determine version
        id: version
        run: |
          # Pega a Ãºltima tag (ou v0.0.0 se nÃ£o existir)
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Last tag: $LAST_TAG"

          # Remove o 'v' da tag e separa em major.minor.patch
          VERSION=${LAST_TAG#v}
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)

          # Analisa commits desde a Ãºltima tag
          COMMITS=$(git log $LAST_TAG..HEAD --pretty=format:"%s")

          # Determina o tipo de bump
          if echo "$COMMITS" | grep -qE "^(feat!|fix!|refactor!|BREAKING CHANGE)"; then
            # Breaking change = major bump
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            BUMP_TYPE="major"
          elif echo "$COMMITS" | grep -qE "^feat(\(.+\))?:"; then
            # Nova feature = minor bump
            MINOR=$((MINOR + 1))
            PATCH=0
            BUMP_TYPE="minor"
          elif echo "$COMMITS" | grep -qE "^(fix|perf)(\(.+\))?:"; then
            # Bug fix ou performance = patch bump
            PATCH=$((PATCH + 1))
            BUMP_TYPE="patch"
          else
            # Sem mudanÃ§as relevantes
            echo "No version bump needed"
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          echo "should_release=true" >> $GITHUB_OUTPUT

      - name: Update version in README and composer.json
        if: steps.version.outputs.should_release == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Atualiza README
          sed -i "s/\*\*VersÃ£o:\*\* .*/\*\*VersÃ£o:\*\* $VERSION/" README.md

          # Atualiza composer.json (adiciona campo version se nÃ£o existir)
          if grep -q '"version"' composer.json; then
            sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" composer.json
          else
            # Adiciona version apÃ³s o campo description
            sed -i "s/\"description\": \"\(.*\)\",/\"description\": \"\1\",\n    \"version\": \"$VERSION\",/" composer.json
          fi

      - name: Generate Changelog
        if: steps.version.outputs.should_release == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          echo "# Release v$VERSION" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## ðŸŽ‰ O que hÃ¡ de novo" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md

          # Features
          FEATURES=$(git log $LAST_TAG..HEAD --pretty=format:"%s" | grep -E "^feat(\(.+\))?:" || true)
          if [ ! -z "$FEATURES" ]; then
            echo "### âœ¨ Novas Funcionalidades" >> RELEASE_NOTES.md
            echo "$FEATURES" | sed 's/^feat/- feat/' >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
          fi

          # Fixes
          FIXES=$(git log $LAST_TAG..HEAD --pretty=format:"%s" | grep -E "^fix(\(.+\))?:" || true)
          if [ ! -z "$FIXES" ]; then
            echo "### ðŸ› CorreÃ§Ãµes de Bugs" >> RELEASE_NOTES.md
            echo "$FIXES" | sed 's/^fix/- fix/' >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
          fi

          # Performance
          PERF=$(git log $LAST_TAG..HEAD --pretty=format:"%s" | grep -E "^perf(\(.+\))?:" || true)
          if [ ! -z "$PERF" ]; then
            echo "### âš¡ Performance" >> RELEASE_NOTES.md
            echo "$PERF" | sed 's/^perf/- perf/' >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
          fi

          # Refactoring
          REFACTOR=$(git log $LAST_TAG..HEAD --pretty=format:"%s" | grep -E "^refactor(\(.+\))?:" || true)
          if [ ! -z "$REFACTOR" ]; then
            echo "### â™»ï¸ RefatoraÃ§Ãµes" >> RELEASE_NOTES.md
            echo "$REFACTOR" | sed 's/^refactor/- refactor/' >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
          fi

          # Documentation
          DOCS=$(git log $LAST_TAG..HEAD --pretty=format:"%s" | grep -E "^docs(\(.+\))?:" || true)
          if [ ! -z "$DOCS" ]; then
            echo "### ðŸ“š DocumentaÃ§Ã£o" >> RELEASE_NOTES.md
            echo "$DOCS" | sed 's/^docs/- docs/' >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
          fi

          cat RELEASE_NOTES.md

      - name: Commit version changes
        if: steps.version.outputs.should_release == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md composer.json
          git commit -m "chore(release): v$VERSION [skip ci]"
          git push

      - name: Create Git Tag
        if: steps.version.outputs.should_release == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"

      - name: Create GitHub Release
        if: steps.version.outputs.should_release == 'true'
        uses: ncipollo/release-action@v1
        with:
          tag: "v${{ steps.version.outputs.version }}"
          name: "Release v${{ steps.version.outputs.version }}"
          bodyFile: "RELEASE_NOTES.md"
          draft: false
          prerelease: false
          artifacts: "coverage.xml"
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload coverage to Codecov
        if: steps.version.outputs.should_release == 'true'
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage.xml
          fail_ci_if_error: false
